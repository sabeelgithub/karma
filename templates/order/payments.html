{% extends 'base.html' %}
{% load static %}
{% block content%}
<!-- Start Banner Area -->
    <section class="banner-area organic-breadcrumb">
        <div class="container">
            <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
                <div class="col-first">
                    <h1>Payment</h1>
                    <nav class="d-flex align-items-center">
                        <a href="index.html">Home<span class="lnr lnr-arrow-right"></span></a>
                        <a href="single-product.html">payment</a>
                    </nav>
                </div>
            </div>
        </div>
    </section>
    <!-- End Banner Area -->
     <section class="checkout_area section_gap">
        <div class="container">
            
         
            <div class="billing_details">
                <div class="row">
                    <div class="col-lg-8">
                    <div class="card m-3">
                          <h5 class="card-header">Billing address</h5>
                        <div class="card-body">
                         <p class="card-text mb-0">{{order.full_name}}</p>
                          <p class="card-text mb-0">{{order.full_address}}</p>
                          <p class="card-text mb-0">{{order.city}}, {{order.state}}</p>
                          <p class="card-text mb-0">{{order.country}}</p>
                          <p class="card-text mb-0">{{order.email}}</p>
                          <p class="card-text mb-0">{{order.phone}}</p>
                          {% if order.order_note %}
                          <b>Order Note:</b>{{order.order_note}}
                          {% endif %}
                       </div>
                    </div>
                     <div class="card m-3">
                          <h5 class="card-header">Review Products</h5>
                        <div class="card-body">
                         
                         <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Product</th>
                                <th scope="col"></th>
                                <th scope="col">Quantity</th>
                                <th scope="col">Total</th>

                                
                            </tr>
                        </thead>
                        <tbody>
              
                            {% for cart_item in cart_items %}
                            <tr>
                                <td >
                                    <div class="media">
                                        <div class="d-flex">
                                           <a href="#">  <img src="{{ cart_item.product.image1.url }}" style="width:70px;height:70px" alt=""></a>
                                        </div>
                                        <div class="media-body" style="margin-left:10px;">
                                           <p class = "text-primary medium">{{ cart_item.product.product_name }}</p>
                                          <p class = "text-danger small" style="margin-top: -21px;">
                                          {% if cart_item.variations.all %}
                                          {% for item in cart_item.variations.all %}
                                          {{ item.variation_category | capfirst }} : {{ item.variation_value | capfirst }} <br>
                                          {% endfor %}
                                          {% endif %}
                                          </p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <h5></h5>
                                </td>
                                <td>
                                    <p class="card-text">{{ cart_item.quantity }}</p>
                                </td>
                                <td>
                                    <h5>₹{{ cart_item.sub_total }}</h5>
                                </td>
                               
                            </tr>
                            {% endfor %}
                           
                           
                          
                        </tbody>
                    </table>
                       </div>
                    </div>
                    </div>
                    <div class="col-lg-4 mt-0">
                        <div class="order_box mt-5 pt-5">
                            <h2>Proceed payment</h2>
                            
                            <ul class="list">
                            
                                <li><a href="#"><strong>Product</strong><span><strong>Total</span></strong></a></li>
                                {% for cart_item in cart_items %}
                                <li><a href="#">{{ cart_item.product.product_name }}<span class="middle">x {{ cart_item.quantity }}</span> <span class="last">₹{{ cart_item.sub_total }}</span></a></li>

                             {% endfor %}
                            <ul class="list list_2">
                                <li><a href="#">Net total <span>₹{{total}}</span></a></li>
                                <li><a href="#">tax <span>₹{{tax}}</span></a></li>
                                {% if coupon_discount %}

                                 <li>  <div class="cart_subtotal d-flex justify-content-between">
                                  <a class="text-warning">Discount :</a>
                                    <span class="cart_amount text-warning">-₹{{coupon_discount}}</span>
                               </div></li>

                                {% endif %}
                                <li><a href="#">Grand total <span>₹{{grand_total}}</span></a></li>
                            </ul>
                            
                          <!-- Button trigger modal -->

 <button type ="submit" class="btn btn-primary btn-lg btn-block mb-2"  data-toggle="modal" data-target="#a{{i.id}}"  >Cash on Delivary</button>
 <div id="paypal-button-container">
</div>

<!-- Modal -->
<div class="modal fade" id="a{{i.id}}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">payment confirmation</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
    <h5 class="modal-title" id="exampleModalLabel">You are Choosed Cash On Delivary</h5>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <a href="{% url 'cash_on_delivery' order_number %}"><button type="button" class="btn btn-primary">Proceed</button></a>
      </div>
    </div>
  </div>
</div>
 <!-- Set up a container element for the button -->
                           {% comment %} <div id="paypal-button-container" style="width:294px;height:66px;">
                           </div> {% endcomment %}


                            {% comment %} <button type ="submit" class="primary-btn m-2" style="width:294px;height:66px;" >Cash on Delivary</button> {% endcomment %}
                            {% comment %} <button type ="submit" class="primary-btn m-2" style="width:294px;height:66px; background: white;" ><img class="img-fluid" src="{% static 'img/razor/riz.jpeg'%}" alt=""></button>
                            {% comment %} <button type ="submit" class="primary-btn m-2" style="width:294px;height:66px;" >Paypal </button> {% endcomment %} 
                              <!-- Set up a container element for the button -->
                           {% comment %} <div id="paypal-button-container">
                           </div> {% endcomment %}

                            
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </section>
    <!--================end payment =================-->
    
     
   <!--paypal-->
    <script src="https://www.paypal.com/sdk/js?client-id=AT1Ktl9NZX0bdIVhIFfvOjqfKDW5TvuaFxVO5lVaTdnSar8jCMdbbW6ZEDCGdNznqKdAUO1LCQO5B3Az&currency=USD"></script>
<script>
function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
        }
 var amount = "{{grand_total}}" 
 var url = "{% url 'payments' %}"
 var csrftoken = getCookie('csrftoken');
 var orderID = "{{order.order_number}}"
 var payment_method = 'Paypal'
 var redirect_url = "{% url 'payments_completed' %}"
  // wait for on load event to ensure the JS SDK is loaded
  window.addEventListener('load', (event) => {
    var options = {
      createOrder: function(data, actions) {
        // This function sets up the details of the transaction, including the amount and line item details. 
        return actions.order.create({
          purchase_units: [{
            amount: {
              value: amount,
            }
          }]
        });
      },
      onApprove: function(data, actions) {
        // This function captures the funds from the transaction. 
        return actions.order.capture().then(function(details) {
          // This function shows a transaction success message to your buyer. 
          console.log(details);
          
          
          sendData();
          function sendData(){
            fetch(url,{
                method :"POST",
                headers : {
                    "Content-type": "application/json",
                    "X-CSRFToken": csrftoken,
                },
                body: JSON.stringify({
                    orderID: orderID,
                    transID: details.id,
                    status: details.status,
                    payment_method:payment_method,
                }),

            })
             .then((response) => response.json())
             .then((data) => {
                console.log('Success',data);
                console.log(data.transID +" transid testing")
                console.log('Transaction completed')
                window.location.href = redirect_url + '?order_number='+data.order_number+'&payment_id='+data.transID;
             });
          }
        })
      }
    };
    // This function displays Smart Payment Buttons on your web page. 
    window.paypal.Buttons(options).render('#paypal-button-container');
  });
                        </script>
    
{%endblock%}